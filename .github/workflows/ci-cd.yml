# CI/CD Pipeline para CICDDemo
# Este workflow se ejecuta en cada push y pull request a la rama main

name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # Job de Build y Test
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    # Checkout del código
    - name: Checkout código
      uses: actions/checkout@v4

    # Configurar .NET SDK
    - name: Configurar .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # Restaurar dependencias
    - name: Restaurar dependencias
      run: dotnet restore

    # Compilar el proyecto
    - name: Build
      run: dotnet build --configuration Release --no-restore

    # Ejecutar tests
    - name: Ejecutar Tests
      run: dotnet test --configuration Release --no-build --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./coverage

    # Publicar resultados de cobertura (opcional)
    - name: Publicar reporte de cobertura
      uses: codecov/codecov-action@v3
      if: github.event_name == 'push'
      with:
        directory: ./coverage
        fail_ci_if_error: false
        verbose: true
      continue-on-error: true

  # Job de análisis de código (opcional pero recomendado)
  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Configurar .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restaurar dependencias
      run: dotnet restore

    # Verificar formato del código
    - name: Verificar formato de código
      run: dotnet format --verify-no-changes --verbosity diagnostic
      continue-on-error: true

  # Job de publicación (solo en push a main)
  publish:
    name: Publish Artifacts
    runs-on: ubuntu-latest
    needs: [build-and-test, code-analysis]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Configurar .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restaurar dependencias
      run: dotnet restore

    - name: Publicar aplicación
      run: dotnet publish src/CICDDemo.Api/CICDDemo.Api.csproj --configuration Release --output ./publish

    # Subir artefactos
    - name: Subir artefactos
      uses: actions/upload-artifact@v4
      with:
        name: app-artifacts
        path: ./publish
        retention-days: 30

